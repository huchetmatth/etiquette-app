<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Sanit-Eticket Tactile</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+EAN13+Text&display=swap" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: auto; }
        h1 { color: #2c3e50; }
        
        /* Grille de vignettes */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .vignette { 
            background: white; padding: 30px 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer; font-weight: bold; font-size: 1.1em; transition: 0.2s; border: 2px solid transparent;
        }
        .vignette:hover { transform: translateY(-5px); border-color: #3498db; }
        .category-vignette { background: #3498db; color: white; }
        .product-vignette { background: #27ae60; color: white; }

        /* Configuration finale */
        #config-zone { display: none; background: white; padding: 20px; border-radius: 12px; margin-top: 20px; }
        input { font-size: 1.2em; padding: 10px; width: 80px; text-align: center; }
        .btn-retour { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }

        /* √âtiquettes pour l'impression */
        #print-area { display: none; }
        .etiquette { 
            width: 300px; height: auto; border: 1px solid black; padding: 10px; 
            margin: 10px auto; page-break-after: always; text-align: center; background: white;
        }
        .barcode { font-family: 'Libre Barcode EAN13 Text'; font-size: 70px; margin: 5px 0; }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

<div class="container no-print">
    <h1>Sanit-Eticket üè∑Ô∏è</h1>
    <button id="btn-back" class="btn-retour" style="display:none;" onclick="showCategories()">‚Üê Retour aux familles</button>
    
    <div id="display-zone" class="grid">
        </div>

    <div id="config-zone">
        <h2 id="selected-product-name"></h2>
        <p>Combien d'√©tiquettes √† imprimer ?</p>
        <input type="number" id="nb-labels" value="1" min="1">
        <br><br>
        <button onclick="preparerImpression()" style="background:#2ecc71; color:white; border:none; padding:15px 30px; font-size:1.1em; border-radius:8px; cursor:pointer;">G√âN√âRER LES √âTIQUETTES</button>
    </div>
</div>

<div id="print-area"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAL76ws_htNLwAfwvebVX9YPfqtawKUTTk",
        authDomain: "sanit-eticket.firebaseapp.com",
        projectId: "sanit-eticket",
        storageBucket: "sanit-eticket.firebasestorage.app",
        appId: "1:819999183475:web:becb59ecfb8e7ac185d006"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let catalogue = [];
    let produitSelectionne = null;

    // 1. Charger les produits et extraire les cat√©gories
    async function initApp() {
        const snapshot = await db.collection("produits_referentiel").get();
        catalogue = snapshot.docs.map(doc => doc.data());
        showCategories();
    }

    // 2. Afficher les familles (Vignettes Bleues)
    function showCategories() {
        document.getElementById("btn-back").style.display = "none";
        document.getElementById("config-zone").style.display = "none";
        const zone = document.getElementById("display-zone");
        zone.style.display = "grid";
        zone.innerHTML = "";

        const categories = [...new Set(catalogue.map(p => p.categorie))];
        
        categories.forEach(cat => {
            const div = document.createElement("div");
            div.className = "vignette category-vignette";
            div.innerText = cat;
            div.onclick = () => showProducts(cat);
            zone.appendChild(div);
        });
    }

    // 3. Afficher les produits d'une famille (Vignettes Vertes)
    function showProducts(cat) {
        document.getElementById("btn-back").style.display = "inline-block";
        const zone = document.getElementById("display-zone");
        zone.innerHTML = "";

        const produits = catalogue.filter(p => p.categorie === cat);
        
        produits.forEach(prod => {
            const div = document.createElement("div");
            div.className = "vignette product-vignette";
            div.innerText = prod.nom;
            div.onclick = () => selectProduct(prod);
            zone.appendChild(div);
        });
    }

    // 4. S√©lection finale
    function selectProduct(prod) {
        produitSelectionne = prod;
        document.getElementById("display-zone").style.display = "none";
        document.getElementById("config-zone").style.display = "block";
        document.getElementById("selected-product-name").innerText = prod.nom;
    }

    // 5. G√©n√©rer les X √©tiquettes
    function preparerImpression() {
        const nb = document.getElementById("nb-labels").value;
        const printArea = document.getElementById("print-area");
        printArea.innerHTML = "";

        const today = new Date().toLocaleDateString('fr-FR');
        const dlcDate = new Date();
        dlcDate.setDate(dlcDate.getDate() + 20); // DLC √† 20 jours
        const dlcString = dlcDate.toLocaleDateString('fr-FR');
        
        const lot = produitSelectionne.nom.substring(0,3).toUpperCase() + new Date().getDate() + (new Date().getMonth()+1);

        for (let i = 0; i < nb; i++) {
            printArea.innerHTML += `
                <div class="etiquette">
                    <div style="font-weight:bold; font-size:1.2em; border-bottom:1px solid black; padding-bottom:5px; margin-bottom:5px;">${produitSelectionne.nom.toUpperCase()}</div>
                    <div class="barcode">${produitSelectionne.ean13}</div>
                    <div style="font-family:monospace; margin-top:-10px;">${produitSelectionne.ean13}</div>
                    <div style="text-align:left; font-size:0.85em; margin-top:10px;">
                        <div><b>Date Fab / Sous-vide :</b> ${today}</div>
                        <div style="color:red;"><b>DLC (20j) :</b> ${dlcString}</div>
                        <div><b>LOT :</b> ${lot}</div>
                    </div>
                </div>
            `;
        }
        window.print();
    }

    initApp();
</script>
</body>
</html>
