<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Sanit-Eticket - Code-Barres</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .form-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; max-width: 400px; }
        h2 { margin-top: 0; color: #1a73e8; }
        input { display: block; margin-bottom: 15px; width: calc(100% - 20px); padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #218838; }
        
        /* Style de l'√©tiquette pro */
        #etiquette-print { 
            display: none; 
            background: white; width: 350px; border: 2px solid #000; padding: 20px; text-align: center; margin-top: 20px;
        }
        .etiquette-header { border-bottom: 3px solid #000; margin-bottom: 10px; font-weight: 900; font-size: 1.4em; letter-spacing: 2px; }
        .lot-box { font-size: 1.2em; font-weight: bold; margin: 10px 0; border: 1px solid #000; padding: 5px; }
        .dlc-zone { color: #d9534f; font-weight: bold; font-size: 1.3em; margin: 10px 0; }
        
        /* Zone Code-Barres */
        .barcode { 
            font-family: 'Libre Barcode 128', crossorigin; 
            font-size: 60px; 
            margin-top: 10px;
            line-height: 1;
        }

        @media print {
            body * { visibility: hidden; }
            #etiquette-print, #etiquette-print * { visibility: visible; }
            #etiquette-print { position: absolute; left: 0; top: 0; display: block; border: none; }
            .btn-print { display: none; } /* Cache le bouton imprimer sur le papier */
        }
    </style>
</head>
<body>

<div class="form-container">
    <h2>Nouvelle √âtiquette</h2>
    <input id="designation" placeholder="Produit (ex: SAUCE TOMATE)">
    <input id="poids" placeholder="Poids net (kg)">
    <input id="dlc" type="number" placeholder="DLC (en jours)">
    <input id="operateur" placeholder="Initiale Op√©rateur">
    <button onclick="saveProduction()">G√âN√âRER L'√âTIQUETTE</button>
</div>

<div id="etiquette-print">
    <div class="etiquette-header">TRA√áABILIT√â CUISINE</div>
    
    <div id="view-designation" style="text-transform: uppercase; font-size: 1.5em; font-weight: bold;"></div>
    
    <div class="lot-box" id="view-lot"></div>
    
    <div class="barcode" id="view-barcode"></div>
    
    <p>Poids : <span id="view-poids" style="font-weight: bold;"></span> kg</p>
    <div class="dlc-zone">√Ä CONSOMMER AVANT LE : <br><span id="view-dlc"></span></div>
    
    <p style="font-size: 0.9em; border-top: 1px solid #eee; padding-top: 10px;">
        Fait le : <span id="view-date-fait"></span> par <span id="view-operateur" style="font-weight: bold;"></span>
    </p>

    <button class="btn-print" onclick="window.print()" style="background: #555; margin-top: 10px;">üñ®Ô∏è IMPRIMER L'√âTIQUETTE</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAL76ws_htNLwAfwvebVX9YPfqtawKUTTk",
        authDomain: "sanit-eticket.firebaseapp.com",
        projectId: "sanit-eticket",
        storageBucket: "sanit-eticket.firebasestorage.app",
        messagingSenderId: "819999183475",
        appId: "1:819999183475:web:becb59ecfb8e7ac185d006"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function saveProduction() {
        const designation = document.getElementById("designation").value;
        const poids = document.getElementById("poids").value;
        const dlcDays = parseInt(document.getElementById("dlc").value);
        const operateur = document.getElementById("operateur").value;

        if(!designation || !poids || isNaN(dlcDays)) {
            alert("‚ö†Ô∏è Erreur : Remplis tous les champs."); return;
        }

        const today = new Date();
        const dlcDate = new Date();
        dlcDate.setDate(today.getDate() + dlcDays);

        const dlcString = dlcDate.toLocaleDateString('fr-FR');
        const faitLeString = today.toLocaleDateString('fr-FR');

        // G√©n√©ration du LOT unique (Ex: JAMB1102)
        const lot = designation.substring(0,4).toUpperCase() + today.getDate() + (today.getMonth()+1);

        // --- Mise √† jour de l'affichage ---
        document.getElementById("view-designation").innerText = designation;
        document.getElementById("view-poids").innerText = poids;
        document.getElementById("view-dlc").innerText = dlcString;
        document.getElementById("view-lot").innerText = "LOT : " + lot;
        document.getElementById("view-barcode").innerText = lot; // On √©crit le lot avec la police code-barres
        document.getElementById("view-operateur").innerText = operateur;
        document.getElementById("view-date-fait").innerText = faitLeString;
        
        document.getElementById("etiquette-print").style.display = "block";

        // --- Envoi Firebase ---
        db.collection("productions").add({
            designation, poids, dateFabrication: today, dateDLC: dlcDate, operateur, lot
        }).catch(err => alert("Erreur base de donn√©es : " + err));
    }
</script>

</body>
</html>
