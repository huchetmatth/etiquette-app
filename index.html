<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Sanit-Eticket Pro - Tactile</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+EAN13+Text&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3498db; --green: #27ae60; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; text-align: center; }
        
        /* Grille de vignettes */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; }
        .vignette { 
            background: white; padding: 40px 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer; font-weight: bold; font-size: 1.2em; transition: 0.2s; border: 3px solid transparent;
            display: flex; align-items: center; justify-content: center; min-height: 80px;
        }
        .vignette:hover { transform: scale(1.02); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .category-vignette { background: var(--blue); color: white; }
        .product-vignette { background: var(--green); color: white; }

        /* Configuration Impression */
        #config-zone { display: none; background: white; padding: 30px; border-radius: 15px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-group { margin: 15px 0; font-size: 1.1em; }
        input { font-size: 1.1em; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; width: 120px; }
        .btn-print { background: var(--dark); color: white; border: none; padding: 15px 40px; font-size: 1.2em; border-radius: 10px; cursor: pointer; margin-top: 20px; }
        .btn-back { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-weight: bold; }

        /* Design de l'√©tiquette (Impression) */
        #print-area { display: none; }
        .etiquette { 
            width: 320px; border: 1px solid black; padding: 10px; margin: 10px auto; 
            text-align: center; background: white; page-break-after: always;
        }
        .barcode { font-family: 'Libre Barcode EAN13 Text'; font-size: 80px; margin: 5px 0; }
        .dlc-tag { background: black; color: white; font-weight: bold; padding: 4px; display: inline-block; margin-top: 5px; width: 100%; }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
        }
    </style>
</head>
<body>

<div class="container no-print">
    <h1>üè∑Ô∏è Sanit-Eticket</h1>
    <button id="btn-back" class="btn-back" style="display:none;" onclick="showCategories()">‚Üê Retour aux familles</button>
    
    <div id="display-zone" class="grid">
        </div>

    <div id="config-zone">
        <h2 id="selected-product-name" style="color:var(--green)"></h2>
        
        <div class="input-group">
            <label>Initiales Op√©rateur :</label><br>
            <input type="text" id="op-initials" placeholder="ex: AB" maxlength="3" style="text-transform: uppercase;">
        </div>

        <div class="input-group">
            <label>Nombre d'√©tiquettes :</label><br>
            <input type="number" id="nb-labels" value="1" min="1">
        </div>

        <button class="btn-print" onclick="preparerImpression()">G√âN√âRER & IMPRIMER</button>
    </div>
</div>

<div id="print-area"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // TA CONFIGURATION FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyAL76ws_htNLwAfwvebVX9YPfqtawKUTTk",
        authDomain: "sanit-eticket.firebaseapp.com",
        projectId: "sanit-eticket",
        storageBucket: "sanit-eticket.firebasestorage.app",
        appId: "1:819999183475:web:becb59ecfb8e7ac185d006"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let catalogue = [];
    let produitSelectionne = null;

    async function initApp() {
        const snapshot = await db.collection("produits_referentiel").get();
        catalogue = snapshot.docs.map(doc => doc.data());
        if(catalogue.length === 0) {
            document.getElementById("display-zone").innerHTML = "<p>Aucun produit trouv√© dans Firebase. Importez votre fichier Excel !</p>";
        } else {
            showCategories();
        }
    }

    function showCategories() {
        document.getElementById("btn-back").style.display = "none";
        document.getElementById("config-zone").style.display = "none";
        const zone = document.getElementById("display-zone");
        zone.style.display = "grid";
        zone.innerHTML = "";

        const categories = [...new Set(catalogue.map(p => p.categorie))];
        categories.forEach(cat => {
            const div = document.createElement("div");
            div.className = "vignette category-vignette";
            div.innerText = cat.toUpperCase();
            div.onclick = () => showProducts(cat);
            zone.appendChild(div);
        });
    }

    function showProducts(cat) {
        document.getElementById("btn-back").style.display = "inline-block";
        const zone = document.getElementById("display-zone");
        zone.innerHTML = "";

        const produits = catalogue.filter(p => p.categorie === cat);
        produits.forEach(prod => {
            const div = document.createElement("div");
            div.className = "vignette product-vignette";
            div.innerText = prod.nom;
            div.onclick = () => selectProduct(prod);
            zone.appendChild(div);
        });
    }

    function selectProduct(prod) {
        produitSelectionne = prod;
        document.getElementById("display-zone").style.display = "none";
        document.getElementById("config-zone").style.display = "block";
        document.getElementById("selected-product-name").innerText = prod.nom;
    }

    function preparerImpression() {
        const nb = document.getElementById("nb-labels").value;
        const initials = document.getElementById("op-initials").value.toUpperCase();
        
        if(!initials) { alert("Merci de saisir vos initiales"); return; }

        const printArea = document.getElementById("print-area");
        printArea.innerHTML = "";

        const now = new Date();
        const dateStr = now.toLocaleDateString('fr-FR');
        
        const dlc = new Date();
        dlc.setDate(now.getDate() + 20);
        const dlcStr = dlc.toLocaleDateString('fr-FR');
        
        const lot = produitSelectionne.nom.substring(0,3).toUpperCase() + now.getDate() + (now.getMonth()+1);

        for (let i = 0; i < nb; i++) {
            printArea.innerHTML += `
                <div class="etiquette">
                    <div style="font-weight:bold; font-size:1.3em; border-bottom:2px solid black; margin-bottom:5px;">${produitSelectionne.nom.toUpperCase()}</div>
                    <div class="barcode">${produitSelectionne.ean13}</div>
                    <div style="font-family:monospace; margin-top:-10px; font-size:0.9em;">${produitSelectionne.ean13}</div>
                    <div style="text-align:left; font-size:0.8em; margin-top:10px; line-height:1.4;">
                        <div><b>FAB / SOUS-VIDE LE :</b> ${dateStr}</div>
                        <div class="dlc-tag">DLC (20j) : ${dlcStr}</div>
                        <div style="margin-top:5px;"><b>LOT :</b> ${lot} | <b>OP :</b> ${initials}</div>
                    </div>
                </div>
            `;
        }

        // Sauvegarde de l'action dans l'historique Firebase
        db.collection("productions").add({
            produit: produitSelectionne.nom,
            ean13: produitSelectionne.ean13,
            operateur: initials,
            date: now,
            dlc: dlc,
            lot: lot,
            quantite: nb
        });

        window.print();
    }

    initApp();
</script>

</body>
</html>
