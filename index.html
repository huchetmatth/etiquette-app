<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Sanit-Eticket - Liaison Stock</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+EAN13+Text&display=swap" rel="stylesheet">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        select, input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button { width: 100%; padding: 15px; background: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* Étiquette */
        #etiquette-section { display: none; margin-top: 20px; background: white; border: 2px solid black; padding: 15px; width: 300px; text-align: center; }
        .barcode { font-family: 'Libre Barcode EAN13 Text'; font-size: 75px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Générer Étiquette Stock</h2>
    
    <label>Sélectionner le produit :</label>
    <select id="select-produit" onchange="updateEAN()">
        <option value="">-- Charger les produits... --</option>
    </select>

    <input id="poids" placeholder="Poids net (kg)">
    <input id="dlc" type="number" placeholder="DLC (jours)">
    <input id="operateur" placeholder="Initiales">
    
    <button onclick="genererEtiquette()">VALIDER & ENREGISTRER</button>
</div>

<div id="etiquette-section">
    <div id="view-nom" style="font-weight: bold; font-size: 1.2em;"></div>
    <div id="view-barcode" class="barcode"></div>
    <div id="view-ean-text" style="margin-top:-10px; font-family: monospace;"></div>
    <div style="text-align: left; margin-top: 10px; font-size: 0.9em;">
        <div>LOT : <span id="view-lot"></span></div>
        <div>POIDS : <span id="view-poids"></span> kg</div>
        <div style="background: black; color: white; padding: 5px; margin-top: 5px;">
            DLC : <span id="view-dlc"></span>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAL76ws_htNLwAfwvebVX9YPfqtawKUTTk",
        authDomain: "sanit-eticket.firebaseapp.com",
        projectId: "sanit-eticket",
        storageBucket: "sanit-eticket.firebasestorage.app",
        messagingSenderId: "819999183475",
        appId: "1:819999183475:web:becb59ecfb8e7ac185d006"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. CHARGER LES PRODUITS DEPUIS FIREBASE AU DÉMARRAGE
    function chargerReferentiel() {
        const select = document.getElementById("select-produit");
        
        // On va chercher dans la collection "produits_referentiel"
        db.collection("produits_referentiel").get().then((querySnapshot) => {
            select.innerHTML = '<option value="">-- Choisir un produit --</option>';
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                let opt = document.createElement('option');
                opt.value = data.ean13; // On stocke l'EAN dans la valeur
                opt.innerHTML = data.nom;
                opt.dataset.dlc = data.dlc_par_defaut || 3; // On peut stocker la DLC par défaut
                select.appendChild(opt);
            });
        });
    }

    function updateEAN() {
        const select = document.getElementById("select-produit");
        const selectedOption = select.options[select.selectedIndex];
        if(selectedOption.dataset.dlc) {
            document.getElementById("dlc").value = selectedOption.dataset.dlc;
        }
    }

    function genererEtiquette() {
        const select = document.getElementById("select-produit");
        const eanStock = select.value;
        const nomProduit = select.options[select.selectedIndex].text;
        const poids = document.getElementById("poids").value;
        const dlcDays = parseInt(document.getElementById("dlc").value);
        
        if(!eanStock) return alert("Sélectionne un produit !");

        const dateDLC = new Date();
        dateDLC.setDate(dateDLC.getDate() + dlcDays);

        const lot = nomProduit.substring(0,3).toUpperCase() + new Date().getDate() + (new Date().getMonth()+1);

        // Affichage
        document.getElementById("view-nom").innerText = nomProduit;
        document.getElementById("view-barcode").innerText = eanStock;
        document.getElementById("view-ean-text").innerText = eanStock;
        document.getElementById("view-lot").innerText = lot;
        document.getElementById("view-poids").innerText = poids;
        document.getElementById("view-dlc").innerText = dateDLC.toLocaleDateString('fr-FR');
        document.getElementById("etiquette-section").style.display = "block";

        // Enregistrement de la production (mouvement de stock)
        db.collection("productions").add({
            produit: nomProduit,
            ean13: eanStock,
            poids: poids,
            date: new Date(),
            dlc: dateDLC
        });
    }

    chargerReferentiel();
</script>
</body>
</html>
